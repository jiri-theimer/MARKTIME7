@model BO.p41Project

@inject BL.Factory _f

@{


    if (Model == null)
    {
        return;
    }
    BO.p51PriceList _rootPriceList = null;

    bool _bolRowHover = false;
    if (_f.CurrentUser.j02Ping_DeviceTypeFlag == BO.DeviceTypeFlag.Desktop) _bolRowHover = true;

    int _BillingLangIndex = _f.p41ProjectBL.GetBillingLangIndex(Model);
    string _BillingLangHtml = _f.p41ProjectBL.GetBillingLangFlagHtml(_BillingLangIndex);

    BO.p28Contact _recP28 = null;
    if (Model.p28ID_Client > 0)
    {
        _recP28 = _f.p28ContactBL.Load(Model.p28ID_Client);
    }
    if (Model.p51ID_Billing == 0 && _recP28 != null)
    {
        if (_recP28.p51ID_Billing == 0)
        {
            _rootPriceList = _f.p51PriceListBL.LoadRootPriceList(DateTime.Now);
        }
    }

    int _p92ID = Model.p92ID;
    string _p92Name = Model.p92Name;
    if (_p92ID == 0 && _recP28 != null && _recP28.p92ID > 0)
    {
        _p92ID = _recP28.p92ID;
        _p92Name = _recP28.p92Name;
    }
    string _Odberatel=null;
    if (Model.p28ID_Billing>0 && Model.p28ID_Billing != Model.p28ID_Client)
    {
        var recOdberatel = _f.p28ContactBL.Load(Model.p28ID_Billing);
        if (recOdberatel != null)
        {
            _Odberatel = recOdberatel.p28Name;
        }
    }

    BO.p31BudgetCompare _bcomp = null;
    bool _isBudget = false;
    bool _isBudgetAllow = false;
    bool _isBudgetByFakturace = false;
    bool _isVysledovka = false;
    bool _isVysledovkaAllow = false;

    double _fakturovatVyka = 0;
    double _ziskPlan = 0;
    double _ziskVyka = 0;
    double _nakladyPlan = 0;
    double _nakladyVyka = 0;
    int _intBudgetScenarVydaje = 2;
    int _intBudgetScenarHodiny = 1;
    int _intVysledovkaScenarVydaje = 2; //1: Všechny peněžní výdaje jsou na odpis, 2: Fa peněžní výdaje pře-fakturovat
    int _intVysledovkaScenarHodiny = 1; //1: Fa hodiny fakturovat, Nefa hodiny odepsat, 2: Všechny hodiny odepsat
    double _vysledovkaNaklad = 0;
    double _vysledovkaVynos = 0;
    double _vysledovkaNakladVyuctovano=0;

    BO.Model.TimesheetCostRateEnum _NakladovaSazbaScenar = (BO.Model.TimesheetCostRateEnum) _f.CBL.LoadUserParamInt("vysledovka-nakladovasazba-scenar", 5);
    double _dblSimulacniSazba = BO.Code.Bas.InDouble(_f.CBL.LoadUserParam("vysledovka-NakladovaSazbaCislo", (_f.Lic.j27ID == 2 ? "500" : "25")));
    double _dblProcentoZFakSazby = BO.Code.Bas.InDouble(_f.CBL.LoadUserParam("vysledovka-NakladovaSazbaProcento","50"));



    string _p51Name_Internal=null;   
    if (Model.p51ID_Internal > 0)
    {
        _p51Name_Internal = _f.p51PriceListBL.Load(Model.p51ID_Internal).p51Name;
    }


    if (_f.CurrentUser.IsVysledovkyAccess || Model.p41Plan_Hours != 0 || Model.p41Plan_Expenses != 0 || Model.p41Plan_Revenue != 0 && (Model.p41BillingFlag != BO.p41BillingFlagEnum.NuloveSazbyBezWip && Model.p41BillingFlag != BO.p41BillingFlagEnum.NuloveSazbyWip))
    {
        _isVysledovkaAllow = true;
        _isVysledovka = _f.CBL.LoadUserParamBool("tab1-p41-vysledovka", false);
    }
    if (_isVysledovka)
    {
        _bcomp = _f.p31WorksheetBL.LoadBudgetCompare("p41", Model.pid, _NakladovaSazbaScenar, _dblSimulacniSazba, _dblProcentoZFakSazby);
        if (_bcomp.Hodiny==0 && _bcomp.Vydaje==0 && _bcomp.Odmeny == 0 && _bcomp.Kusovnik==0)
        {
            _isVysledovka = false;
            _isVysledovkaAllow = false;
        }
        else
        {
            _intVysledovkaScenarVydaje = _f.CBL.LoadUserParamInt("vysledovka-scenar-vydaje", 2);
            _intVysledovkaScenarHodiny = _f.CBL.LoadUserParamInt("vysledovka-scenar-hodiny", 1);
        }

        _vysledovkaNaklad = _bcomp.Vydaje + _bcomp.Honorar_Naklad + _bcomp.Kusovnik_Naklad;
        _vysledovkaVynos = _bcomp.Odmeny;
        if (_intVysledovkaScenarHodiny == 1)
        {
            _vysledovkaVynos += _bcomp.Honorar + _bcomp.Kusovnik_Honorar;
        }
        if (_intVysledovkaScenarVydaje == 2)
        {
            _vysledovkaVynos += _bcomp.VydajeFa;
        }

        _vysledovkaNakladVyuctovano = _bcomp.Vyuctovano_Honorar_Naklad + _bcomp.Vyuctovano_Vydaje_Vykazane;
    }

    if (Model.p41Plan_Hours != 0 || Model.p41Plan_Expenses != 0 || Model.p41Plan_Revenue != 0)
    {
        _isBudgetAllow = true;
        _isBudget = _f.CBL.LoadUserParamBool("tab1-p41-rozpocet", false);
        _intBudgetScenarVydaje = _f.CBL.LoadUserParamInt("rozpocet-scenar-vydaje", 2);
        _intBudgetScenarHodiny = _f.CBL.LoadUserParamInt("rozpocet-scenar-hodiny", 1);
        if (_bcomp==null)
        {
            _bcomp = _f.p31WorksheetBL.LoadBudgetCompare("p41", Model.pid, _NakladovaSazbaScenar, _dblSimulacniSazba, _dblProcentoZFakSazby);
        }

        if (_dblSimulacniSazba != 0)
        {
            Model.p41Plan_Internal_Fee = Model.p41Plan_Hours * _dblSimulacniSazba;
        }
        _nakladyPlan = Model.p41Plan_Expenses + Model.p41Plan_Internal_Fee;


        if (_intBudgetScenarHodiny == 1)
        {
            _fakturovatVyka = _bcomp.Odmeny + _bcomp.Honorar;   //fakturovat fa hodiny+odměny
        }
        if (_intBudgetScenarHodiny == 2)
        {
            _fakturovatVyka = _bcomp.Odmeny;            //fakturovat pouze odměny
        }
        if (_intBudgetScenarVydaje == 1)
        {
            _nakladyVyka = _bcomp.Vydaje + _bcomp.Honorar_Naklad;
        }
        if (_intBudgetScenarVydaje == 2)
        {
            _nakladyVyka = _bcomp.VydajeNefa + _bcomp.Honorar_Naklad;
            _fakturovatVyka += _bcomp.VydajeFa;
        }
        _ziskVyka = _fakturovatVyka - _nakladyVyka;
        _ziskPlan = Model.p41Plan_Revenue - _nakladyPlan;


    }
    if (_bcomp !=null && (_bcomp.Vyuctovano_BezDph>0 || _bcomp.Vyuctovano_Hodiny > 0))
    {
        _isBudgetByFakturace = true;
    }

}

@addTagHelper *, UI

@if (Model.p41BillingFlag == BO.p41BillingFlagEnum.NuloveSazbyBezWip)
{
    <myicon symbol="local_cafe"></myicon>
    <code>Interní projekt</code>
    <br />
    <var>Nulové fakturační sazby.</var>
    <br />
    <var>Úkony vyloučené z vyúčtování.</var>
    return;
}
@if (Model.p41BillingFlag == BO.p41BillingFlagEnum.NuloveSazbyWip)
{
    <myicon symbol="local_bar"></myicon>
    <code>Interní projekt</code>
    <br />
    <var>Nulové fakturační sazby.</var>
    <br />
    <var>Možnost schvalování/vyúčtování úkonů.</var>
    return;
}

@if (!_isVysledovka && _isVysledovkaAllow)
{
    <a class="mytreeview-toggle-kontejner" href="javascript:billingbox_change_value('1','tab1-p41-vysledovka')">
        <span class="material-icons-outlined-btn mytreeview-toggle-sipka">arrow_right</span>
    </a>
    <a class="btn px-0" href="javascript:billingbox_change_value('1','tab1-p41-vysledovka')">
        <myicon symbol="balance"></myicon>
        @_f.tra("Výsledovka projektu")

    </a>
}

@if (_isVysledovka)
{
    <table class="table table-sm table-hover" style="min-width:400px;">
        <tr style="vertical-align:bottom">
            <td>

                <div class="dropdown">
                    <a class="mytreeview-toggle-kontejner" onclick="billingbox_change_value('0','tab1-p41-vysledovka')">
                        <span class="material-icons-outlined-btn mytreeview-toggle-sipka">arrow_drop_down</span>                                                
                    </a>
                    <a class="btn dropdown-toggle px-0" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <myicon symbol="balance"></myicon>
                        @_f.tra("Výsledovka projektu")
                        
                    </a>

                    <div class="dropdown-menu" style="padding:10px;background-color:aliceblue;">


                        <a href="javascript: _window_open('/Vysledovka/Index?master_entity=p41&master_pid=@(Model.pid)')">@_f.tra("Podrobnější výsledovky")</a>

                        <a class="btn btn-sm btn-light" title="Rychlá statistika" href="javascript:_window_open('/Record/QuickStat?prefix=p41&pid=@(Model.pid)')"><myicon symbol="auto_graph"></myicon></a>
                        <a class="btn btn-sm btn-light" title="SOUČTY" href="javascript:_window_open('/p31Totals/Index?selected_entity=p41&selected_pids=@(Model.pid)&blank=1')"><myicon symbol="functions"></myicon></a>
                        <a class="btn btn-sm btn-light" title="Pevný report" href="javascript:_window_open('/ReportsClient/ReportContext?prefix=p41&pid=@(Model.pid)')"><myicon symbol="print"></myicon></a>
                                                

                        <hr />

                        <label for="cbxNakladovaSazbaScenar">Nákladová sazba hodin:</label>
                        <select id="cbxNakladovaSazbaScenar">
                            <option value="1">Nákladová sazba úkonu (N1)</option>"
                            <option value="2">Režijní sazba úkonu (N2)</option>"
                            <option value="3">Simulační sazba projektu (N3)</option>"
                            <option value="4">Simulační sazba uživatele (N4)</option>"
                            <option value="5">Simulační sazbu zadat zde ručně (N5)</option>
                            <option value="6">Procento z fakturační sazby (N6)</option>
                        </select>

                        @if (_NakladovaSazbaScenar == BO.Model.TimesheetCostRateEnum.SimulacniSazbaRucne)
                        {
                            <br />
                            <label for="txtSimulacniSazba">Simulační nákladová sazba:</label>
                            <input id="txtSimulacniSazba" onchange="billingbox_change_simulacni_sazba()" type="text" style="width:40px;" value="@(_dblSimulacniSazba)" />
                        }
                        @if (_NakladovaSazbaScenar == BO.Model.TimesheetCostRateEnum.ProcentoFakturacniSazby)
                        {
                            <br />
                            <label for="txtProcentoFakSazby">Procento z fakturační sazby:</label>
                            <input id="txtProcentoFakSazby" onchange="billingbox_change_procento_sazba()" type="text" style="width:30px;" value="@(_dblProcentoZFakSazby)" />
                            <span>%</span>
                        }
                        

                        <hr />

                        <select id="cbxVysledovkaScenarVydaje" onchange="billingbox_change_scenar(this,'vysledovka-scenar-vydaje')">
                            <option value="1">Všechny peněžní výdaje jsou na odpis</option>
                            <option value="2">Fa peněžní výdaje pře-fakturovat</option>
                        </select>
                        <p></p>
                        <select id="cbxVysledovkaScenarHodiny" onchange="billingbox_change_scenar(this,'vysledovka-scenar-hodiny')">
                            <option value="1">Fa hodiny fakturovat, Nefa hodiny odepsat</option>
                            <option value="2">Všechny hodiny odepsat</option>
                        </select>

                    </div>
                </div>
            </td>
            <td class="numcell">
                @_f.tra("Náklad")
            </td>
            <td class="numcell">
                @_f.tra("Výnos")
            </td>
            <td style="text-align:center;">
                @_f.tra("Zisk/Ztráta")


            </td>

        </tr>
        @if (_bcomp.Hodiny != 0)
        {
            <tr>
                <td>
                    @_f.tra("Hodiny")                    
                    <span class="badge-light" title="Celkem vykázané hodiny v projektu">@BO.Code.Bas.Num2StringNull(_bcomp.Hodiny)</span>                    
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Honorar_Naklad)
                    @if (_NakladovaSazbaScenar==BO.Model.TimesheetCostRateEnum.SimulacniSazbaRucne)
                    {
                        <br />
                        <small style="background-color:lightyellow;padding:3px;">
                            @(_dblSimulacniSazba) x @BO.Code.Bas.Number2String(_bcomp.Hodiny)
                        </small>
                        
                    }
                    @if (_NakladovaSazbaScenar == BO.Model.TimesheetCostRateEnum.SimulacniSazbaProjekt)
                    {
                        <br />
                        <small style="background-color:lightyellow;padding:3px;">
                            @(Model.p41Plan_Internal_Rate) x @BO.Code.Bas.Number2String(_bcomp.Hodiny)
                        </small>

                    }
                    @if (_bcomp.Hodiny > 0 && _bcomp.Honorar_Naklad == 0)
                    {
                        <mytooltip text="Nákladovou hodinovou sazbu získáte buď z ceníku nákladových sazeb nebo z ceníku režijních sazeb.<hr>Sazbu můžete zadat i v kartě uživatele nebo v kartě projektu.<hr>Nebo simulační nákladovou sazbu zadejte zde ručně."></mytooltip>
                    }
                </td>
                <td class="numcell">
                    @if (_intVysledovkaScenarHodiny == 1)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Honorar)
                    }                                       
                </td>
                <td class="numcell" style="color:@(_intVysledovkaScenarHodiny==1 && _bcomp.Honorar - _bcomp.Honorar_Naklad>0 ? "green": "red")">
                    @if (_intVysledovkaScenarHodiny==1 && _bcomp.Honorar_Naklad != 0 && _bcomp.Honorar != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Honorar - _bcomp.Honorar_Naklad)
                    }
                    @if (_intVysledovkaScenarHodiny == 2)
                    {
                        @BO.Code.Bas.Num2StringNull(-1*_bcomp.Honorar_Naklad)
                    }
                </td>

               
            </tr>
            
        }
        @if (_bcomp.Kusovnik != 0)
        {
            <tr>
                <td>
                    @_f.tra("Kusovník")                    
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Kusovnik_Naklad)
                    
                    
                </td>
                <td class="numcell">
                    @if (_intVysledovkaScenarHodiny == 1)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Kusovnik_Honorar)
                    }
                </td>
                <td class="numcell" style="color:@(_intVysledovkaScenarHodiny==1 && _bcomp.Kusovnik_Honorar - _bcomp.Kusovnik_Naklad>0 ? "green": "red")">
                    @if (_intVysledovkaScenarHodiny == 1 && (_bcomp.Kusovnik_Honorar != 0 || _bcomp.Kusovnik_Naklad != 0))
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Kusovnik_Honorar - _bcomp.Kusovnik_Naklad)
                    }
                    @if (_intVysledovkaScenarHodiny == 2)
                    {
                        @BO.Code.Bas.Num2StringNull(-1 * _bcomp.Kusovnik_Honorar)
                    }
                </td>


            </tr>

        }
        @if (_bcomp.Vydaje != 0)
        {
            <tr>
                <td>
                    @_f.tra("Peněžní výdaje")
                    
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vydaje)
                </td>
                <td class="numcell">
                    @if (_intVysledovkaScenarVydaje == 2)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.VydajeFa)
                    }
                    

                </td>
                <td class="numcell" style="color:red">
                    @if (_intVysledovkaScenarVydaje == 2)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.VydajeFa - _bcomp.Vydaje)
                    }
                    else
                    {
                        @BO.Code.Bas.Num2StringNull(-1*_bcomp.Vydaje)
                    }

                </td>

            </tr>
        }
        @if (_bcomp.Odmeny != 0)
        {
            <tr>
                <td>
                    @_f.tra("Pevné odměny")

                </td>
                <td class="numcell">
                    
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Odmeny)

                </td>
                <td class="numcell" style="color:green">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Odmeny)

                </td>

            </tr>
        }
        <tr style="background-color:aliceblue">
            <td>
                @if (_vysledovkaVynos != 0 || _vysledovkaNaklad !=0)
                {
                    @if (_vysledovkaVynos - _vysledovkaNaklad > 0)
                    {
                        <myicon symbol="sentiment_satisfied"></myicon>
                    }
                    else
                    {
                        <myicon color="red" symbol="sentiment_worried"></myicon>
                    }
                }
            </td>
            <td class="numcell">
                @(BO.Code.Bas.Num2StringNull(_vysledovkaNaklad))
            </td>
            <td class="numcell">
                @(BO.Code.Bas.Num2StringNull(_vysledovkaVynos))

            </td>
            <td class="numcell" style="color:@(_vysledovkaVynos>_vysledovkaNaklad ? "green": "red")">
                <strong>
                    @BO.Code.Bas.Num2StringNull(_vysledovkaVynos - _vysledovkaNaklad)
                </strong>
            </td>

        </tr>
        @if (_bcomp.Vyuctovano_BezDph != 0 || _bcomp.Vyuctovano_Hodiny_Vykazane != 0)
        {
            <tr style="background-color:palegreen;">

                <td colspan="4">
                    <var>Výsledovka z vyúčtovaných úkonů:</var>
                </td>
            </tr>
        }
        @if (_bcomp.Vyuctovano_Hodiny_Vykazane != 0)
        {
            <tr>
                <td>
                    @_f.tra("Hodiny")
                    <span class="badge-light" title="Hodiny zahrnuté do vyúčtování">@BO.Code.Bas.Number2String(_bcomp.Vyuctovano_Hodiny_Vykazane)</span>
                    @if(_bcomp.Vyuctovano_Hodiny != 0)
                    {
                        <span class="badge-a4" title="Hodiny vyúčtované statusem: Fakturovat">@BO.Code.Bas.Number2String(_bcomp.Vyuctovano_Hodiny)</span>
                    }
                    @if (_bcomp.Vyuctovano_Hodiny_6 != 0)
                    {
                        <span class="badge-a6" title="Hodiny vyúčtované statusem: Zahrnout do paušálu">@BO.Code.Bas.Number2String(_bcomp.Vyuctovano_Hodiny_6)</span>
                    }
                    @if (_bcomp.Vyuctovano_Hodiny_2 != 0)
                    {
                        <span class="badge-a2" title="Hodiny vyúčtované statusem: Viditelný odpis">@BO.Code.Bas.Number2String(_bcomp.Vyuctovano_Hodiny_2)</span>
                    }
                    @if (_bcomp.Vyuctovano_Hodiny_3 != 0)
                    {
                        <span class="badge-a3" title="Hodiny vyúčtované statusem: Skrytý odpis">@BO.Code.Bas.Number2String(_bcomp.Vyuctovano_Hodiny_3)</span>
                    }
                   
                    

                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Honorar_Naklad)
                    @if (_bcomp.Vyuctovano_Hodiny_Vykazane > 0 && _bcomp.Vyuctovano_Honorar_Naklad == 0)
                    {
                        <mytooltip text="Nákladovou hodinovou sazbu získáte buď z ceníku nákladových sazeb nebo z ceníku režijních sazeb.<hr>Sazbu můžete zadat i v kartě uživatele nebo v kartě projektu.<hr>Nebo simulační nákladovou sazbu zadejte zde ručně."></mytooltip>
                    }
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Honorar)
                    
                    
                </td>
                <td class="numcell" style="color:@(_bcomp.Vyuctovano_Honorar - _bcomp.Vyuctovano_Honorar_Naklad>0 ? "green": "red")">
                    @if (_bcomp.Vyuctovano_Honorar != 0 && _bcomp.Vyuctovano_Honorar_Naklad != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Honorar - _bcomp.Vyuctovano_Honorar_Naklad)
                    }
                   
                </td>


            </tr>
            
        }
        @if (_bcomp.Vyuctovano_Kusovnik != 0 || _bcomp.Vyuctovano_Kusovnik_Naklad !=0)
        {
            <tr>
                <td>
                    @_f.tra("Kusovník")                                        

                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Kusovnik_Naklad)
                   
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Kusovnik)


                </td>
                <td class="numcell" style="color:@(_bcomp.Vyuctovano_Kusovnik - _bcomp.Vyuctovano_Kusovnik_Naklad>0 ? "green": "red")">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Kusovnik - _bcomp.Vyuctovano_Kusovnik_Naklad)

                </td>


            </tr>

        }
        @if (_bcomp.Vyuctovano_Vydaje_Vykazane != 0)
        {
            <tr>
                <td>
                    @_f.tra("Peněžní výdaje")

                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Vydaje_Vykazane)
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Vydaje)


                </td>
                <td class="numcell" style="color:@(_bcomp.Vyuctovano_Vydaje - _bcomp.Vyuctovano_Vydaje_Vykazane>0 ? "green": "red")">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Vydaje - _bcomp.Vyuctovano_Vydaje_Vykazane)

                </td>

            </tr>
        }
        @if (_bcomp.Vyuctovano_Odmeny != 0)
        {
            <tr>
                <td>
                    @_f.tra("Pevné odměny")

                </td>
                <td class="numcell">
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Odmeny)

                </td>
                <td class="numcell" style="color:green">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_Odmeny)

                </td>

            </tr>
        }
        @if (_bcomp.Vyuctovano_BezDph != 0 || _bcomp.Vyuctovano_Hodiny_Vykazane != 0)
        {
            <tr style="background-color:aliceblue">
                <td>
                    @if (_bcomp.Vyuctovano_BezDph - _vysledovkaNakladVyuctovano > 0)
                    {
                        <myicon symbol="sentiment_satisfied"></myicon>
                    }
                    else
                    {
                        <myicon color="red" symbol="sentiment_worried"></myicon>
                    }
                </td>
                <td class="numcell">
                    @(BO.Code.Bas.Num2StringNull(_vysledovkaNakladVyuctovano))
                </td>
                <td class="numcell">
                    @(BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_BezDph))

                </td>
                <td class="numcell" style="color:@(_bcomp.Vyuctovano_BezDph>_vysledovkaNakladVyuctovano ? "green": "red")">
                    <strong>
                        @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_BezDph - _vysledovkaNakladVyuctovano)
                    </strong>
                </td>

            </tr>
        }
        
    </table>
}

@if (!_isBudget && _isBudgetAllow)
{
    <br />
    <a class="mytreeview-toggle-kontejner" href="javascript:billingbox_change_value('1','tab1-p41-rozpocet')">
        <span class="material-icons-outlined-btn mytreeview-toggle-sipka">arrow_right</span>
    </a>
    <a class="btn px-0" href="javascript:billingbox_change_value('1','tab1-p41-rozpocet')">
        <myicon symbol="target"></myicon>
        @_f.tra("Rozpočet projektu")

    </a>
}

@if (_isBudget)
{
    <table class="table table-sm table-hover" style="min-width:400px;">
        <tr>
            <td>

                <div class="dropdown">
                    <a class="mytreeview-toggle-kontejner" onclick="billingbox_change_value('0','tab1-p41-rozpocet')">
                        <span class="material-icons-outlined-btn mytreeview-toggle-sipka">arrow_drop_down</span>
                    </a>
                    <a class="btn dropdown-toggle px-0" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <myicon symbol="target"></myicon>
                        @_f.tra("Rozpočet projektu")
                        
                    </a>
                    
                    @if (!_isBudgetByFakturace)
                    {
                        <div class="dropdown-menu" style="padding:10px;background-color:aliceblue;">

                            <select id="cbxRozpocetScenarVydaje" onchange="billingbox_change_scenar(this,'rozpocet-scenar-vydaje')">
                                <option value="1">Všechny peněžní výdaje jsou náklady</option>
                                <option value="2">Fa peněžní výdaje pře-fakturovat</option>
                            </select>
                            <p></p>
                            <select id="cbxRozpocetScenarHodiny" onchange="billingbox_change_scenar(this,'rozpocet-scenar-hodiny')">
                                <option value="1">Fa hodiny fakturovat, Nefa hodiny odepsat</option>
                                <option value="2">Všechny hodiny odepsat</option>
                            </select>
                        </div>
                    }
                    
                </div>
            </td>
            <td class="numcell" title="Rozpočet/Limitní hodnoty">
                @_f.tra("Plán")
            </td>
            <td class="numcell" title="Realita = vykázané hodiny/výdaje/odměny">
                @_f.tra("Realita")
               
            </td>
            <td style="text-align:center;" colspan="2" title="Zbývá dočerpat z rozpočtu nebo přečerpáno.">
                @_f.tra("Rozdíl")


            </td>

        </tr>


        @if (Model.p41Plan_Hours != 0)
        {
            <tr>
                <td>
                    @_f.tra("Hodiny")
                    
                    </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(Model.p41Plan_Hours)
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Hodiny)
                    @if (_bcomp.Honorar != 0 && _intBudgetScenarHodiny == 1)
                    {
                        <br />
                        <span title="Fakturační honorář z vykázaných hodin" style="color:green">@BO.Code.Bas.Num2StringNull(_bcomp.Honorar)</span>
                    }
                </td>
                <td class="numcell" style="color:@(_bcomp.Hodiny - Model.p41Plan_Hours>0 ? "brown": "darkviolet")">
                    @if (_bcomp.Hodiny != 0 && Model.p41Plan_Hours != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Hodiny - Model.p41Plan_Hours)

                    }

                </td>
                <td class="numcell" style="color:@(_bcomp.Hodiny - Model.p41Plan_Hours>0 ? "brown": "darkviolet")">
                    @if (_bcomp.Hodiny != 0 && Model.p41Plan_Hours != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(100 * _bcomp.Hodiny / Model.p41Plan_Hours)
                        <span>%</span>
                    }
                </td>
            </tr>
        }
        @if (Model.p41Plan_Hours_Billable != 0 && _bcomp.Hodiny != _bcomp.HodinyFa && _f.Lic.x01IsCapacityFaNefa)
        {
            <tr>
                <td>@_f.tra("Hodiny Fa"):</td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(Model.p41Plan_Hours_Billable)
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.HodinyFa)
                </td>
                <td class="numcell" style="color:@(_bcomp.HodinyFa - Model.p41Plan_Hours_Billable>0 ? "brown": "darkviolet")">
                    @if (_bcomp.HodinyFa != 0 && Model.p41Plan_Hours_Billable != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Hodiny - Model.p41Plan_Hours_Billable)
                    }

                </td>
                <td class="numcell" style="color:@(_bcomp.HodinyFa - Model.p41Plan_Hours_Billable>0 ? "brown": "darkviolet")">
                    @if (_bcomp.HodinyFa != 0 && Model.p41Plan_Hours_Billable != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(100 * _bcomp.HodinyFa / Model.p41Plan_Hours_Billable)
                        <span>%</span>
                    }


                </td>
            </tr>
        }
        @if (Model.p41Plan_Hours_Nonbillable != 0 && _f.Lic.x01IsCapacityFaNefa)
        {
            <tr>
                <td>@_f.tra("Hodiny Nefa"):</td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(Model.p41Plan_Hours_Nonbillable)
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.HodinyNefa)
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.HodinyNefa - Model.p41Plan_Hours_Nonbillable)
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(100 * _bcomp.HodinyNefa / Model.p41Plan_Hours_Nonbillable)
                    %
                </td>
            </tr>
        }
        @if (Model.p41Plan_Internal_Fee != 0 || _bcomp.Hodiny > 0)
        {

            @if (_dblSimulacniSazba == 0 && _bcomp.Hodiny > 0 && _bcomp.Honorar_Naklad == 0)
            {
                <tr>

                    <td colspan="5">
                        <code>V rozpočtu chybí uvést simulační nákladovou sazbu nebo ceník nákladových sazeb!</code>

                    </td>
                </tr>
            }
            <tr>
                <td>
                    @_f.tra("Nákladový honorář"):
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(Model.p41Plan_Internal_Fee)
                    @if (_NakladovaSazbaScenar==BO.Model.TimesheetCostRateEnum.SimulacniSazbaRucne)
                    {
                        <br />
                        <small style="background-color:lightyellow;padding:1px;">
                            @(_dblSimulacniSazba) x @BO.Code.Bas.Number2String(Model.p41Plan_Hours)
                        </small>
                    }
                    @if (_NakladovaSazbaScenar == BO.Model.TimesheetCostRateEnum.SimulacniSazbaProjekt)
                    {
                        <br />
                        <small style="background-color:lightyellow;padding:3px;">
                            @(Model.p41Plan_Internal_Rate) x @BO.Code.Bas.Number2String(Model.p41Plan_Hours)
                        </small>

                    }
                </td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Honorar_Naklad)
                    @if (_dblSimulacniSazba > 0 && _bcomp.Hodiny !=0)
                    {
                        <br />
                        <small style="background-color:lightyellow;padding:1px;">
                            @(_dblSimulacniSazba) x @BO.Code.Bas.Number2String(_bcomp.Hodiny)
                        </small>
                    }
                </td>
                <td class="numcell" style="color:@(_bcomp.Honorar_Naklad - Model.p41Plan_Internal_Fee>0 ? "brown": "darkviolet")">
                    @if (Model.p41Plan_Internal_Fee > 0 && _bcomp.Honorar_Naklad != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Honorar_Naklad - Model.p41Plan_Internal_Fee)
                    }

                </td>
                <td class="numcell" style="color:@(_bcomp.Honorar_Naklad - Model.p41Plan_Internal_Fee>0 ? "brown": "darkviolet")">
                    @if (Model.p41Plan_Internal_Fee > 0 && _bcomp.Honorar_Naklad != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(100 * _bcomp.Honorar_Naklad / Model.p41Plan_Internal_Fee)
                        <span>%</span>
                    }

                </td>
            </tr>


        }
        @if (Model.p41Plan_Expenses != 0 || _bcomp.Vydaje != 0)
        {
            <tr>
                <td>@_f.tra("Peněžní výdaje"):</td>
                <td class="numcell">
                    @BO.Code.Bas.Num2StringNull(Model.p41Plan_Expenses)
                </td>
                <td class="numcell" title="Vykázané Fa i Nefa peněžní výdaje">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vydaje)
                </td>
                <td class="numcell" style="color:@(_bcomp.Vydaje - Model.p41Plan_Expenses>0 ? "brown": "darkviolet")">
                    @if (Model.p41Plan_Expenses > 0 && _bcomp.Vydaje != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Vydaje - Model.p41Plan_Expenses)
                    }

                </td>
                <td class="numcell" style="color:@(_bcomp.Vydaje - Model.p41Plan_Expenses>0 ? "brown": "darkviolet")">
                    @if (Model.p41Plan_Expenses > 0 && _bcomp.Vydaje != 0)
                    {
                        @BO.Code.Bas.Num2StringNull(100 * _bcomp.Vydaje / Model.p41Plan_Expenses)
                        <span>%</span>
                    }

                </td>
            </tr>
        }
        @if (_bcomp.Odmeny != 0)
        {
            <tr>
                <td>@_f.tra("Pevné odměny"):</td>
                <td class="numcell">
                </td>
                <td class="numcell" style="color:green;">
                    @BO.Code.Bas.Num2StringNull(_bcomp.Odmeny)
                </td>
                <td class="numcell">
                </td>
                <td class="numcell">
                </td>
            </tr>
        }

        <tr style="background-color:palegreen;">
            <td>
                @if (!_isBudgetByFakturace)
                {
                    @(_f.tra("Fakturovat"))
            
                }
                else
                {
                    @_f.tra("Vyútováno bez DPH")
                }
                <span>:</span>
            </td>
            <td class="numcell">
                @BO.Code.Bas.Num2StringNull(Model.p41Plan_Revenue)
            </td>
            <td class="numcell">
                @if (!_isBudgetByFakturace)
                {
                    @BO.Code.Bas.Num2StringNull(_fakturovatVyka)
                }
                else
                {
                    @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_BezDph)
                }
                
            </td>
            <td class="numcell" style="color:@(_fakturovatVyka - Model.p41Plan_Revenue>0 ? "brown": "darkviolet")">
                @if (Model.p41Plan_Revenue > 0 && _fakturovatVyka != 0)
                {
                    @BO.Code.Bas.Num2StringNull(_fakturovatVyka - Model.p41Plan_Revenue)
                }

            </td>
            <td class="numcell" style="color:@(_fakturovatVyka - Model.p41Plan_Revenue>0 ? "brown": "darkviolet")">
                @if (Model.p41Plan_Revenue > 0 && _fakturovatVyka != 0)
                {
                    @BO.Code.Bas.Num2StringNull(100 * _fakturovatVyka / Model.p41Plan_Revenue)
                    <span>%</span>
                }

            </td>
        </tr>

        <tr style="background-color:#FFCCCB;">
            <td>@_f.tra("Náklady celkem"):</td>
            <td class="numcell">
                @BO.Code.Bas.Num2StringNull(_nakladyPlan)
            </td>
            <td class="numcell">
                @if (!_isBudgetByFakturace)
                {
                    @BO.Code.Bas.Num2StringNull(_nakladyVyka)
                }
                else
                {
                    @BO.Code.Bas.Num2StringNull(_vysledovkaNakladVyuctovano)
                }
                
            </td>
            <td class="numcell" style="color:@(_nakladyVyka - _nakladyPlan>0 ? "brown": "darkviolet")">
                @if (_nakladyPlan > 0 && _nakladyVyka != 0)
                {
                    @BO.Code.Bas.Num2StringNull(_nakladyVyka - _nakladyPlan)
                }

            </td>
            <td class="numcell" style="color:@(_nakladyVyka - _nakladyPlan>0 ? "brown": "darkviolet")">
                @if (_nakladyPlan > 0 && _nakladyVyka != 0)
                {
                    @BO.Code.Bas.Num2StringNull(100 * _nakladyVyka / _nakladyPlan)
                    <span>%</span>
                }

            </td>
        </tr>

        <tr style="background-color:aliceblue;">
            <td>
                @_f.tra("Zisk/Ztráta"):
            </td>
            <td class="numcell" style="color:@(_ziskPlan>0 ? "green": "brown")">
                <strong>
                    @BO.Code.Bas.Num2StringNull(_ziskPlan)
                </strong>

            </td>
            <td class="numcell" style="color:@(_ziskVyka>0 ? "green": "brown")">
                <strong>
                    @if (!_isBudgetByFakturace)
                    {
                        @BO.Code.Bas.Num2StringNull(_ziskVyka)
                    }
                    else
                    {
                        @BO.Code.Bas.Num2StringNull(_bcomp.Vyuctovano_BezDph - _vysledovkaNakladVyuctovano)
                    }
                </strong>


            </td>
            <td class="numcell">
                @if (_ziskVyka != 0)
                {
                    @if (_ziskVyka > 0)
                    {
                        <myicon symbol="sentiment_satisfied"></myicon>
                    }
                    else
                    {
                        <myicon color="red" symbol="sentiment_worried"></myicon>
                    }
                }

            </td>
            <td class="numcell">
            </td>
        </tr>

        @if (Model.p41PlanFrom != null || Model.p41PlanUntil != null)
        {
            <tr>
                <td colspan="5">
                    @if (Model.p41PlanFrom != null)
                    {
                        <span class="badge-light" title="Plánované zahájení">@(BO.Code.Bas.ObjectDate2String(Model.p41PlanFrom))</span>
                    }
                    @if (Model.p41PlanUntil != null)
                    {
                        <span class="badge-def" title="Plánované dokončení">@(BO.Code.Bas.ObjectDate2String(Model.p41PlanUntil))</span>
                    }
                </td>
            </tr>

        }

    </table>

    

}




<table class="table table-hover">

    @if (Model.p51ID_Internal > 0)
    {
        <tr>

            <td>
                <small>@_f.tra("Ceník nákladových sazeb"):</small>
                <br />
                @if (_bolRowHover)
                {
                    <myval value="@_p51Name_Internal" hoverprefix="p51" hoverpid="@Model.p51ID_Internal"></myval>
                }
                else
                {
                    <myval value="@_p51Name_Internal"></myval>
                }
            </td>

        </tr>
    }
    @if (Model.p51ID_Billing > 0)
    {
        <tr>

            <td>
                <small>@_f.tra("Fakturační hodinové sazby")<br />@_f.tra("Ceník projektu"):</small>
                <br />
                @if (_bolRowHover)
                {
                    <myval value="@Model.p51Name_Billing" hoverprefix="p51" hoverpid="@Model.p51ID_Billing"></myval>
                }
                else
                {
                    <myval value="@Model.p51Name_Billing"></myval>
                }
            </td>

        </tr>
    }
    else
    {
        @if (_recP28 != null && _recP28.p51ID_Billing > 0)
        {
            <tr>

                <td>
                    <small>@_f.tra("Fakturační hodinové sazby")<br />@_f.tra("Ceník klienta"):</small>
                    <br />
                    @if (_bolRowHover)
                    {
                        <myval value="@_recP28.p51Name_Billing" hoverprefix="p51" hoverpid="@_recP28.p51ID_Billing"></myval>
                    }
                    else
                    {
                        <myval value="@_recP28.p51Name_Billing"></myval>
                    }
                </td>

            </tr>
        }
        else
        {
            @if (_rootPriceList != null)
            {
                <tr>
                    <td>
                        <small>@_f.tra("Fakturační hodinové sazby")<br />@_f.tra("ROOT ceník"):</small>
                        <br />
                        @if (_bolRowHover)
                        {
                            <myval value="@_rootPriceList.p51Name" hoverprefix="p51" hoverpid="@_rootPriceList.pid"></myval>
                        }
                        else
                        {
                            <myval value="@_rootPriceList.p51Name"></myval>
                        }
                    </td>

                </tr>
            }
            else
            {
                <tr>
                    <td>
                        <small>@_f.tra("Ceník fakturačních sazeb"):</small>
                        
                        <small style="color:silver;">@_f.tra("Nenastaveno")</small>
                        
                    </td>

                </tr>
            }
        }
    }

    <tr>
        <td>
            <small>@_f.tra("Výchozí typ faktury"):</small>
            
            @if (_p92ID > 0)
            {
                <br />
                @if (_bolRowHover)
                {
                    <myval value="@_p92Name" hoverprefix="p92" hoverpid="@_p92ID"></myval>
                }
                else
                {
                    <myval value="@_p92Name"></myval>
                }
            }
            else
            {
                <small style="color:silver;">@_f.tra("Nenastaveno")</small>
                
            }

        </td>

    </tr>


    @if (_BillingLangHtml != null)
    {
        <tr>

            <td title="@_f.tra("Fakturační jazyk")">
               
                <myval datatype="html" value="@_BillingLangHtml"></myval>
            </td>

        </tr>
    }

    @if (_Odberatel !=null)
    {
        <tr>
            <td>
                <small>@_f.tra("Odběratel faktury"):</small>
                <br />
                @if (_bolRowHover)
                {
                    <myval value="@_Odberatel" hoverprefix="p28" hoverpid="@Model.p28ID_Billing"></myval>
                }
                else
                {
                    <myval value="@_Odberatel"></myval>
                }
            </td>

        </tr>
    }

    @if (Model.p41InvoiceMaturityDays > 0)
    {
        <tr>

            <td>
                <small>@_f.tra("Splatnost faktury"):</small>

                <myval value="@Model.p41InvoiceMaturityDays" valueafter="d."></myval>
            </td>

        </tr>


    }

</table>


@if (_isVysledovka || _isBudget || _isVysledovkaAllow || _isBudgetAllow)
{
    <script type="text/javascript">
        $("#cbxNakladovaSazbaScenar").change(function () {

            billingbox_change_value(this.value, "vysledovka-nakladovasazba-scenar");
            
        });

        $("#cbxNakladovaSazbaScenar").val(@((int) _NakladovaSazbaScenar));

        
        if (document.getElementById("cbxRozpocetScenarVydaje")) {
            $("#cbxRozpocetScenarVydaje").val("@(_intBudgetScenarVydaje)");
            $("#cbxRozpocetScenarHodiny").val("@(_intBudgetScenarHodiny)");
        }

        if (document.getElementById("cbxVysledovkaScenarVydaje")) {
            $("#cbxVysledovkaScenarVydaje").val("@(_intVysledovkaScenarVydaje)");
            $("#cbxVysledovkaScenarHodiny").val("@(_intVysledovkaScenarHodiny)");
        }


        function billingbox_change_scenar(cbx, key) {
            $.post(_ep("/Common/SetUserParam"), { key: key, value: cbx.value }, function (data) {
                location.replace(location.href);

            });
        }

        function billingbox_change_value(val, key) {
            
            $.post(_ep("/Common/SetUserParam"), { key: key, value: val }, function (data) {
                location.replace(location.href);

            });
        }

        function billingbox_change_simulacni_sazba() {
            var val = _string2number($("#txtSimulacniSazba").val());

            $.post(_ep("/Common/SetUserParam"), { key: 'vysledovka-NakladovaSazbaCislo', value: val }, function (data) {
                location.replace(location.href);

            });
        }
        function billingbox_change_procento_sazba() {
            var val = _string2number($("#txtProcentoFakSazby").val());

            $.post(_ep("/Common/SetUserParam"), { key: 'vysledovka-NakladovaSazbaProcento', value: val }, function (data) {
                location.replace(location.href);

            });
        }

    </script>
}