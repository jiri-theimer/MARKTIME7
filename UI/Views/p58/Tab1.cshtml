@model UI.Models.Tab1.p58Tab1
@inject BL.Factory _f

@{

    Layout = "~/Views/Shared/_LayoutSubform.cshtml";
    if (Model.Rec == null) return;


    var _NotepadLookAt = new UI.Models.Notepad.LookAtViewModel() { IsTab1 = true, prefix = "p58", pid = Model.Rec.pid, NotepadContent = Model.Rec.p58Notepad, x04ID = Model.Rec.x04ID };
    string _Necekat = _f.tra("Nečekat a vygenerovat ručně");

    IEnumerable<BO.x69EntityRole_Assign> _lisX69 = _f.x67EntityRoleBL.GetList_X69("p58", Model.pid);

}

@addTagHelper *, UI



@Html.Raw("<div class='info_record_container'>")


<div class="card recpagebox400">
    <div class="card-body">
        <div class="card-title recpagetitle bgp40">
            @Model.Rec.p57Name
        </div>

        <div class="row my-1">
            <label class="col-sm-2 col-md-3 col-form-label">@_f.tra("Název úkolu"):</label>
            <div class="col-sm-10 col-md-9">
                <myval value="@Model.Rec.p58Name"></myval>

            </div>
        </div>

        @if (Model.RecP41 != null)
        {
            <div class="row my-1">
                <label class="col-sm-2 col-md-3 col-form-label">@_f.getP07Level(Model.RecP41.p07Level,true):</label>
                <div class="col-sm-10 col-md-9">
                    <myval value="@Model.RecP41.FullName" hoverprefix="p41" hoverpid="@Model.Rec.p41ID"></myval>

                </div>
            </div>
        }


        <div class="row my-1">
            <label class="col-sm-2 col-md-3 col-form-label">RD1:</label>
            <div class="col-sm-4 col-md-4">
                <myval value="@Model.Rec.p58BaseDateStart" datatype="date"></myval>

            </div>
        </div>
        
        <div class="row my-1">
            <label class="col-sm-2 col-md-3 col-form-label">RD2:</label>
            <div class="col-sm-4 col-md-4">
                <myval value="@Model.Rec.p58BaseDateEnd" datatype="date"></myval>

            </div>
        </div>

        @foreach (var c in _lisX69)
            {
            <div class="row">
                <label class="col-sm-2 col-md-3 col-form-label">@(c.x67Name):</label>
                <div class="col-sm-4 col-md-4">
                    @if(c.Person != null)
                    {
                        <myval value="@c.Person"></myval>
                    }
                    @if(c.j11Name != null)
                    {
                        <myval value="@c.j11Name"></myval>
                    }

                </div>
          
            </div>
            }
        

        @if (Model.Rec.p58Plan_Hours > 0)
        {
            <div class="row my-1">
                <label class="col-sm-2 col-md-3 col-form-label">@_f.tra("Plán hodin"):</label>
                <div class="col-sm-4 col-md-4">
                    <myval value="@Model.Rec.p58Plan_Hours" datatype="num"></myval>

                </div>
            </div>
        }
        @if (Model.Rec.p58Plan_Expenses > 0)
        {
            <div class="row my-1">
                <label class="col-sm-2 col-md-3 col-form-label">@_f.tra("Plán výdajů"):</label>
                <div class="col-sm-4 col-md-4">
                    <myval value="@Model.Rec.p58Plan_Expenses" datatype="num"></myval>

                </div>
            </div>
        }
        @if (Model.Rec.p58Plan_Revenue > 0)
        {
            <div class="row my-1">
                <label class="col-sm-2 col-md-3 col-form-label">@_f.tra("Plán odměn"):</label>
                <div class="col-sm-4 col-md-4">
                    <myval value="@Model.Rec.p58Plan_Revenue" datatype="num"></myval>

                </div>
            </div>
        }
    </div>
</div>


@if (Model.lisP59 != null)
{
    <div class="card recpageboxauto">
        <div class="card-body">
            <div class="card-title recpagetitle bgp51">
                @_f.tra("Přesný plán generování úkolů")
            </div>
            <table class="table table-hover">
                <tr>
                    <th>@_f.tra("Název")</th>
                    <th title="Rozhodné datum">@_f.tra("RD")</th>
                    <th>@_f.tra("Zahájení")</th>
                    <th>@_f.tra("Termín")</th>
                    <th>@_f.tra("Datum generování")</th>
                    <th></th>

                </tr>
                @foreach (var c in Model.lisP59)
                {
                    <tr>
                        <td>
                            @c.p59Name
                        </td>
                        <td>
                            @BO.Code.Bas.ObjectDate2String(c.p59BaseDate,"dd.MM.yyyy")
                        </td>
                        <td>
                            @BO.Code.Bas.ObjectDate2String(c.p59PlanFrom,"dd.MM.yyyy")
                        </td>
                        <td>
                            @BO.Code.Bas.ObjectDate2String(c.p59PlanUntil,"dd.MM.yyyy")
                        </td>
                        <td>
                            @BO.Code.Bas.ObjectDate2String(c.p59DateCreate, "dd.MM.yyyy")
                        </td>
                        <td class="rowvalhover">
                            @if (c.p56ID_NewInstance > 0)
                            {
                                <kbd style="background-color:green;">@_f.tra("Již vygenerováno")</kbd>
                                <a class="reczoom" data-rel="/p56/Info?pid=@(c.p56ID_NewInstance)&hover_by_reczoom=1">ℹ</a>                                
                                <br />
                                <var>
                                    @c.p56Name
                                </var>
                                <small>
                                    @BO.Code.Bas.ObjectDateTime2String(c.p56DateInsert)
                                </small>
                            }
                            else
                            {
                                if (c.p59DateCreate.AddDays(10) < DateTime.Now)
                                {
                                    <code>@_f.tra("Robot se již nebude pokoušet úkol generovat.")</code>
                                    <button type="button" class="btn btn-sm bog" onclick="try_generate(@c.p58ID,@c.p59ID)">Vygenerovat ručně</button>
                                }
                                else
                                {
                                   <button type="button" class="btn btn-sm bog" onclick="try_generate(@c.p58ID,@c.p59ID)">@(_Necekat)</button> 
                                }
                                
                            }
                            @if (c.p59ErrorMessage_NewInstance != null)
                            {
                                <span style="color:red;">@c.p59ErrorMessage_NewInstance</span>
                            }


                        </td>



                    </tr>


                }
            </table>


        </div>
    </div>
}





@Html.Raw("</div>")

<div style="clear:both;"></div>

@Html.EditorFor(m => _NotepadLookAt, "~/Views/Shared/_NotepadRO.cshtml")


<script type="text/javascript">
    $(document).ready(function () {



    });

    function try_generate(p58id, p59id) {
        $.post("/p58/TryGenerate_Recurrence_Instance", { p58id: p58id, p59id: p59id }, function (data) {

            if (!data.issuccess) {
                alert(data.message);
                return;
            }

            location.replace(location.href);

        });
    }
</script>